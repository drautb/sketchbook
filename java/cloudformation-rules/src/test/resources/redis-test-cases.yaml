- description: Should have no errors for correct template
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cluster:
        Type: AWS::ElastiCache::CacheCluster
        Properties:
          CacheSubnetGroupName: !Ref cacheSubnetGroup
          VpcSecurityGroupIds: !Ref clusterSgId
          ClusterName: !Ref clusterId
          Port: !Ref port
          NotificationTopicArn: !If [conditionName, !Ref notificationTopicArn, !Ref "AWS::NoValue"]
  errors: []

- description: Should report missing cacheSubnetGroup
  facts:
    stackExists: false
  template:
    Parameters:
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
  errors:
    - Missing required parameter 'cacheSubnetGroup'

- description: Should report missing clusterSgId
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
  errors:
    - Missing required parameter 'clusterSgId'

- description: Should report missing clusterId
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
  errors:
    - Missing required parameter 'clusterId'

- description: Should report missing port
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: String
      clusterId:
        Type: String
      notificationTopicArn:
        Type: String
  errors:
    - Missing required parameter 'port'

- description: Should report missing notificationTopicArn
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: String
      clusterId:
        Type: String
      port:
        Type: Number
  errors:
    - Missing required parameter 'notificationTopicArn'

- description: Should report wrong type for cacheSubnetGroup
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: Number
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
  errors:
    - Parameter 'cacheSubnetGroup' must have type 'String', but found 'Number'

- description: Should report wrong type for clusterSgId
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: String
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
  errors:
    - Parameter 'clusterSgId' must have type 'AWS::EC2::SecurityGroup::Id', but found 'String'

- description: Should report wrong type for clusterId
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: Number
      port:
        Type: Number
      notificationTopicArn:
        Type: String
  errors:
    - Parameter 'clusterId' must have type 'String', but found 'Number'

- description: Should report wrong type for port
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: String
      notificationTopicArn:
        Type: String
  errors:
    - Parameter 'port' must have type 'Number', but found 'String'

- description: Should report that port can not be changed after creation
  facts:
    stackExists: true
    previousParameterValues:
      port: 8000
    incomingParameterValues:
      port: 9000
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cluster:
        Type: AWS::ElastiCache::CacheCluster
        Properties:
          CacheSubnetGroupName: !Ref cacheSubnetGroup
          VpcSecurityGroupIds: !Ref clusterSgId
          ClusterName: !Ref clusterId
          Port: !Ref port
          NotificationTopicArn: !If [conditionName, !Ref notificationTopicArn, !Ref "AWS::NoValue"]
  errors:
    - Parameter 'port' can not be changed without experiencing downtime!  Current value='8000' is being replaced with value='9000'

- description: Should report wrong type for notificationTopicArn
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: Number
  errors:
    - Parameter 'notificationTopicArn' must have type 'String', but found 'Number'

- description: Should complain if no cache resource is present
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cache:
        Type: bogus
  errors:
    - Exactly one cache cluster or replication group is required, but was not found.
    - Only cache clusters, replication groups, and parameter groups are allowed, but found ["bogus"]

- description: Should complain if multiple parameter groups are present
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cache:
        Type: AWS::ElastiCache::CacheCluster
        Properties:
          CacheSubnetGroupName: !Ref cacheSubnetGroup
          VpcSecurityGroupIds: !Ref clusterSgId
          ClusterName: !Ref clusterId
          Port: !Ref port
          NotificationTopicArn: !If [conditionName, !Ref notificationTopicArn, !Ref "AWS::NoValue"]
      pg1:
        Type: AWS::ElastiCache::ParameterGroup
      pg2:
        Type: AWS::ElastiCache::ParameterGroup
  errors:
    - At most one parameter group is allowed, but found 2

- description: Should complain if cacheSubnetGroup isn't referenced
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cache:
        Type: AWS::ElastiCache::CacheCluster
        Properties:
          CacheSubnetGroupName: myOwnSubnetGroup
          VpcSecurityGroupIds: !Ref clusterSgId
          ClusterName: !Ref clusterId
          Port: !Ref port
          NotificationTopicArn: !If [conditionName, !Ref notificationTopicArn, !Ref "AWS::NoValue"]
  errors:
    - The 'CacheSubnetGroupName' property must reference the 'cacheSubnetGroup' input parameter.

- description: Should complain if clusterSgId isn't referenced
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cache:
        Type: AWS::ElastiCache::CacheCluster
        Properties:
          CacheSubnetGroupName: !Ref cacheSubnetGroup
          VpcSecurityGroupIds: otherSgId
          ClusterName: !Ref clusterId
          Port: !Ref port
          NotificationTopicArn: !If [conditionName, !Ref notificationTopicArn, !Ref "AWS::NoValue"]
  errors:
    - The 'VpcSecurityGroupIds' property must reference the 'clusterSgId' input parameter.

- description: Should complain if clusterId isn't referenced
  facts:
    stackExists: false
  template:
    Parameters:
      cacheSubnetGroup:
        Type: String
      clusterSgId:
        Type: AWS::EC2::SecurityGroup::Id
      clusterId:
        Type: String
      port:
        Type: Number
      notificationTopicArn:
        Type: String
    Resources:
      cache:
        Type: AWS::ElastiCache::CacheCluster
        Properties:
          CacheSubnetGroupName: !Ref cacheSubnetGroup
          VpcSecurityGroupIds: !Ref clusterSgId
          ClusterName: myOwnName
          Port: !Ref port
          NotificationTopicArn: !If [conditionName, !Ref notificationTopicArn, !Ref "AWS::NoValue"]
  errors:
    - The 'ClusterName' property must reference the 'clusterId' input parameter.
